<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>H√°bitos de Sue√±o ‚Äî Tinkuy Psicoterap√©utico</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg-rose:#f9e0d9;
      --beige:#f6e2c5;
      --beige-hover:#f3d7b2;
      --text:#2c3e50;
      --track:#39FF14;
      --card:#fff7f2;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family:'Montserrat',sans-serif;
      background-color:var(--bg-rose);
      color:var(--text);
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    /* ===== Header estilo Tinkuy ===== */
    header{
      display:flex;align-items:center;justify-content:space-between;
      padding:16px 24px;
      background: rgba(255,236,210,0.92);
      box-shadow: 0 4px 15px rgba(0,0,0,0.14);
      position: sticky; top:0; z-index:1100;
      backdrop-filter: blur(6px);
    }
    .logo-title{display:flex;align-items:center;gap:14px;}
    .logo{
      width:72px;height:72px;border-radius:50%;
      object-fit:cover; box-shadow: 0 4px 12px rgba(0,0,0,0.18);
      transition: transform .45s ease;
    }
    .logo:hover{ transform: scale(1.08) rotate(3deg); }
    header h1{ font-size:1.6rem; color:#2c3e50; }
    .subtitle-mini{ font-size:.82rem; color:#5b5b5b; }

    nav{ display:flex; gap:26px; align-items:center; flex-wrap:wrap;}
    nav a{
      text-decoration:none; color:#2c3e50; font-weight:600;
      padding:6px 10px; border-radius:8px; transition: all .22s ease;
      font-size:1.1rem;
    }
    nav a:hover{ color:#ff5a36; text-shadow: 0 0 8px #ff5a36; background: rgba(255,255,255,0.35); }

    /* ===== Sidebar Podcast ===== */
    .sidebar{
      position:fixed; left:10px; top:50%; transform:translateY(-50%);
      background: rgba(255,236,210,0.92);
      padding:10px; border-radius:12px;
      box-shadow:0 4px 12px rgba(0,0,0,0.18);
      z-index:1200;
      display:flex; flex-direction:column; gap:18px;
    }
    .sidebar a{
      writing-mode: vertical-rl; transform: rotate(180deg);
      text-decoration:none; font-weight:700; font-size:1rem;
      color:#2c3e50; transition: transform .25s ease, color .25s ease;
    }
    .sidebar a:hover{ color:#ff5a36; transform: rotate(180deg) scale(1.08); }

    main{ flex:1; padding:24px 16px 40px; max-width:1100px; margin:0 auto; width:100%; }

    /* ===== Panel superior del juego ===== */
    .panel{
      display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      background:#fff; padding:12px 14px; border-radius:14px; box-shadow:0 4px 12px rgba(0,0,0,.08); margin-bottom:16px;
    }
    .panel-left{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
    select{padding:8px 10px;border-radius:10px;border:1px solid #ddd;font-size:1rem;background:#fff;}
    button{padding:10px 16px;border:none;border-radius:10px;background:var(--beige);font-weight:600;cursor:pointer;}
    button:hover{background:var(--beige-hover);}
    .dice{display:inline-flex;align-items:center;gap:10px;}
    .dice-face{width:44px;height:44px;display:flex;align-items:center;justify-content:center;background:#fff7f2;border:1px solid #ffe1d2;border-radius:12px;font-weight:700;}
    .progress{font-weight:700;}

    /* ===== Tarjeta del tablero ===== */
    .game-card{background:#fff;padding:16px;border-radius:16px;box-shadow:0 6px 16px rgba(0,0,0,.1);}
    svg{width:100%;height:520px;display:block;}
    .track{stroke:var(--track);stroke-width:12;fill:none;stroke-linecap:round; opacity:.95;}
    .milestone{fill:#ffe6d6; stroke:#c97c48; stroke-width:1.5;}
    .milestone text{font-size:10px; fill:#5b3a22;}
    .player text{font-size:28px;dominant-baseline:middle;text-anchor:middle;}

    .message{
      margin-top:14px;background:var(--card);border:1px solid #ffe4d6;border-radius:14px;padding:16px;line-height:1.65;
    }

    /* ===== Modal reutilizable ===== */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);z-index:2000;padding:16px;}
    .modal.open{display:flex;}
    .modal-card{background:#fff;max-width:760px;width:100%;padding:18px 18px 16px;border-radius:16px;box-shadow:0 16px 40px rgba(0,0,0,.25);}
    .modal h3{margin-bottom:10px;}
    .modal .content{line-height:1.7;color:#223;}
    .modal .actions{margin-top:14px;display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;}
    .badge{display:inline-block;background:#fff7f2;border:1px solid #ffd8c3;border-radius:999px;padding:4px 10px;font-size:.85rem;font-weight:700;color:#8B4513;}

 
    /* ===== Footer ===== */
    footer{
      text-align:center;
      padding:18px 14px;
      background: rgba(255,236,210,0.92);
      box-shadow: 0 -4px 12px rgba(0,0,0,0.06);
      font-size:.95rem;
      margin-top:auto;
    }

    @media (max-width: 820px){
      svg{height:460px;}
      .sidebar{left:4px}
    }
/* ==== Chatbot flotante ==== */
.chatbot-btn {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: #5e60ce;
  color: #fff;
  border: none;
  border-radius: 50%;
  width: 60px;
  height: 60px;
  font-size: 28px;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  z-index: 2000;
}
.chatbot-window {
  position: fixed;
  bottom: 90px;
  right: 20px;
  width: 320px;
  max-height: 420px;
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 6px 16px rgba(0,0,0,0.25);
  display: none;
  flex-direction: column;
  overflow: hidden;
  z-index: 2000;
}
.chatbot-header {
  background: #5e60ce;
  color: #fff;
  padding: 10px;
  font-weight: bold;
  text-align: center;
}
.chatbot-messages {
  flex: 1;
  padding: 10px;
  overflow-y: auto;
  font-size: 0.95rem;
}
.chatbot-input {
  display: flex;
  border-top: 1px solid #ddd;
}
.chatbot-input input {
  flex: 1;
  padding: 8px;
  border: none;
  outline: none;
}
.chatbot-input button {
  background: #5e60ce;
  color: #fff;
  border: none;
  padding: 8px 12px;
  cursor: pointer;
}
    
  </style>
</head>
<body>
  <!-- Sidebar podcast vertical -->
  <div class="sidebar" aria-label="barra lateral">
    <a href="https://open.spotify.com/episode/4CUWRXyzr5elbkb5oSs0hm?si=opdPQpweRc-deo5I0f4kvQ&nd=1&dlsi=b322c09736b048b8" target="_blank" rel="noopener noreferrer">üò¥ Podcast</a>
    <a href="https://pmc.ncbi.nlm.nih.gov/articles/PMC4667374/">üìñ Base cient√≠fica</a>
    <a href="https://www.youtube.com/watch?v=Lbn5HzoiveQ" target="_blank" rel="noopener noreferrer">üìπ Video psicoeducativo</a>

  </div>

  <!-- Header -->
  <header>
    <div class="logo-title">
      <img src="../logometapsytinkuy.jpeg" alt="Logo MetaPsy Tinkuy" class="logo" width="72" height="72">
      <div>
        <h1>MetaPsy Tinkuy</h1>
        <div class="subtitle-mini">Tinkuy Psicoterap√©utico</div>
      </div>
    </div>

    <nav aria-label="Navegaci√≥n principal">
      <a href="../index.html">Inicio</a>
      <a href="../nosotros.html">Nosotros</a>
      <a href="../proyectos.html">Proyectos</a>
      <a href="../contacto.html">Contacto</a>
      <a href="./index.html" aria-current="page">Tinkuy Psicoterap√©utico</a>
    </nav>
  </header>

  <main>
    <h2 style="text-align:center; font-size:2rem; margin:14px 0 6px;">El Camino al Buen Descanso üåô</h2>
    <p style="text-align:center; color:#444; margin-bottom:16px;">Avanza por 50 casillas. Lanza el dado, responde s√≠/no. Si aciertas avanzas; si fallas retrocedes. Aprende h√°bitos de sue√±o <span class="badge">basados en evidencia</span>.</p>

    <div class="panel">
      <div class="panel-left">
        <label for="avatar"><strong>Avatar:</strong></label>
        <select id="avatar">
          <option value="üåô" selected>üåô Luna</option>
          <option value="üò¥">üò¥ Carita dormida</option>
          <option value="üö∂‚Äç‚ôÇÔ∏è">üö∂‚Äç‚ôÇÔ∏è Caminante</option>
          <option value="üêë">üêë Oveja</option>
          <option value="üßë">üßë Persona</option>
          <option value="üêª">üêª Osito</option>
        </select>
      </div>
      <div class="dice">
        <button id="rollBtn">Lanzar dado üé≤</button>
        <div class="dice-face" id="diceFace">‚Äî</div>
      </div>
      <button id="resetBtn">Reiniciar</button>
      <div class="progress" id="progress">Paso 1 de 50</div>
    </div>

    <div class="game-card">
      <svg viewBox="0 0 1000 560" preserveAspectRatio="xMidYMid meet" aria-label="tablero serpenteante">
        <!-- Senda serpenteante -->
        <path id="track" class="track"
          d="M 60 520
             C 200 460, 320 600, 460 520
             S 700 440, 840 500
             S 940 480, 900 380
             S 760 320, 620 360
             S 480 400, 360 320
             S 240 260, 160 320
             S 120 400, 220 440
             S 420 500, 600 460
             S 820 400, 860 300
             S 760 200, 620 240
             S 480 280, 360 200
             S 240 140, 160 200
             S 120 280, 200 340
             S 360 400, 540 360
             S 720 300, 820 220
             S 900 160, 780 120
             S 620 100, 480 160
             S 360 200, 260 160
             S 160 120, 100 160" />
        <!-- Hitos numerados -->
        <g id="milestones"></g>
        <!-- Avatar -->
        <g id="player" class="player"><text id="playerEmoji" x="0" y="0">üåô</text></g>
      </svg>

      <div class="message" id="message">
        Lanza el dado para comenzar. Si respondes bien, avanzas lo que indica el dado; si fallas, retrocedes lo mismo.
      </div>
    </div>
  </main>

<!-- Bot√≥n flotante -->
<button class="chatbot-btn" onclick="toggleChat()">üò¥</button>

<!-- Ventana del chatbot -->
<div class="chatbot-window" id="chatbot">
  <div class="chatbot-header">Asistente del Sue√±o üò¥</div>
  <div class="chatbot-messages" id="chatMessages"></div>
  <div class="chatbot-input">
    <input type="text" id="chatInput" placeholder="Escribe tu pregunta..." />
    <button onclick="sendMessage()">Enviar</button>
  </div>
</div>
  
  <footer>
    ¬© 2025 MetaPsy Tinkuy ‚Äî Tinkuy Psicoterap√©utico. Todos los derechos reservados.
    <br>Contacto: <a href="mailto:giuliano.milla@upch.pe">giuliano.milla@upch.pe</a>
  </footer>

  <!-- Modal de Preguntas -->
  <div class="modal" id="qModal" role="dialog" aria-modal="true" aria-labelledby="qTitle">
    <div class="modal-card">
      <h3 id="qTitle">Pregunta de higiene del sue√±o</h3>
      <div id="qText" class="content" style="margin-top:6px;"></div>
      <div class="actions">
        <button id="btnNo">No</button>
        <button id="btnYes">S√≠</button>
      </div>
      <div id="qFeedback" class="content" style="margin-top:10px;"></div>
    </div>
  </div>

  <!-- Modal Psicoeducaci√≥n -->
  <div class="modal" id="eduModal" role="dialog" aria-modal="true" aria-labelledby="eduTitle">
    <div class="modal-card">
      <h3 id="eduTitle">Nota psicoeducativa</h3>
      <div id="eduText" class="content" style="margin-top:6px;"></div>
      <div class="actions">
        <button id="btnContinue">Continuar</button>
      </div>
    </div>
  </div>

  <script>
    // ===== Utilidades SVG / Tablero =====
    const N_STEPS = 50; // 50 casillas
    const track = document.getElementById('track');
    const milestonesG = document.getElementById('milestones');
    const playerEmojiEl = document.getElementById('playerEmoji');
    const progressEl = document.getElementById('progress');
    const messageEl = document.getElementById('message');

    const rollBtn = document.getElementById('rollBtn');
    const diceFace = document.getElementById('diceFace');
    const resetBtn = document.getElementById('resetBtn');
    const avatarSel = document.getElementById('avatar');

    const qModal = document.getElementById('qModal');
    const qText = document.getElementById('qText');
    const qFeedback = document.getElementById('qFeedback');
    const btnYes = document.getElementById('btnYes');
    const btnNo = document.getElementById('btnNo');

    const eduModal = document.getElementById('eduModal');
    const eduText = document.getElementById('eduText');
    const btnContinue = document.getElementById('btnContinue');

    let pathLen;
    let points = []; // puntos equidistantes sobre la senda
    let currentIdx = 0; // 0..49 (mostrar 1..50)
    let lastRoll = 0;
    let rollingLocked = false;

    // ===== Preguntas (15) s√≠/no con explicaci√≥n basada en evidencia =====
    const questions = [
      {
        q: "¬øLa luz azul de pantallas por la noche puede retrasar el inicio del sue√±o?",
        ans: true,
        exp: "Correcto. La luz azul inhibe la secreci√≥n de melatonina y desplaza el ritmo circadiano. Minimiza pantallas 1‚Äì2 h antes de dormir o usa filtros nocturnos."
      },
      {
        q: "¬øEs recomendable acostarse y levantarse a horas muy variables entre semana y fines de semana?",
        ans: false,
        exp: "No. La constancia horaria fortalece tu reloj biol√≥gico. Mantener una ventana estable de sue√±o-vigilia mejora latencia y calidad del descanso."
      },
      {
        q: "¬øConsumir caf√© 6 horas antes de dormir puede afectar el sue√±o?",
        ans: true,
        exp: "S√≠. La cafe√≠na tiene vida media de 3‚Äì7 h. Ev√≠tala desde media tarde para no aumentar la latencia y fragmentar el sue√±o."
      },
      {
        q: "¬øEl alcohol ayuda a dormir profundamente toda la noche?",
        ans: false,
        exp: "Induce somnolencia inicial pero fragmenta el sue√±o y reduce REM. Evita alcohol al acercarse la hora de dormir."
      },
      {
        q: "¬øHacer ejercicio regular (no muy tarde) mejora la calidad del sue√±o?",
        ans: true,
        exp: "Correcto. Actividad f√≠sica moderada diurna reduce latencia y aumenta sue√±o profundo. Evita ejercicio intenso 2‚Äì3 h antes de dormir."
      },
      {
        q: "¬øDormir siestas largas (>60 min) por la tarde suele facilitar conciliar el sue√±o nocturno?",
        ans: false,
        exp: "Siestas largas reducen la presi√≥n de sue√±o. Prefiere siestas breves (10‚Äì20 min) y tempranas si las necesitas."
      },
      {
        q: "¬øUna rutina relajante previa (lectura, respiraci√≥n) ayuda a conciliar el sue√±o?",
        ans: true,
        exp: "S√≠. Se√±ales consistentes pre-sue√±o condicionan al cuerpo a bajar activaci√≥n (arousal) y benefician la latencia."
      },
      {
        q: "¬øEs √∫til quedarse en la cama si no puedes dormir durante 30‚Äì40 minutos?",
        ans: false,
        exp: "No. Lev√°ntate, haz algo tranquilo con poca luz y vuelve cuando aparezca somnolencia. Evita asociar cama con vigilia."
      },
      {
        q: "¬øLa habitaci√≥n m√°s fresca (‚âà18‚Äì20¬∞C), oscura y silenciosa favorece el sue√±o?",
        ans: true,
        exp: "S√≠. Control de temperatura, luz y sonido optimiza el ambiente de sue√±o y reduce microdespertares."
      },
      {
        q: "¬øCenar muy pesado justo antes de dormir es recomendable?",
        ans: false,
        exp: "Ev√≠talo. Las comidas copiosas cerca de la hora de dormir incrementan reflujo y activaci√≥n digestiva."
      },
      {
        q: "¬øExponerse a luz natural por la ma√±ana ayuda a regular el ritmo circadiano?",
        ans: true,
        exp: "Correcto. Luz matutina sincroniza el reloj biol√≥gico (zeitgeber potente) y facilita el inicio del sue√±o nocturno."
      },
      {
        q: "¬øFumar ayuda a dormir mejor?",
        ans: false,
        exp: "La nicotina es estimulante, aumenta la latencia y fragmenta el sue√±o. Evita nicotina especialmente por la tarde-noche."
      },
      {
        q: "¬øTener relojes visibles y chequear la hora repetidamente ayuda a conciliar el sue√±o?",
        ans: false,
        exp: "Mirar la hora aumenta la ansiedad de desempe√±o del sue√±o. Voltea el reloj o ret√≠ralo del campo visual."
      },
      {
        q: "¬øLas t√©cnicas de respiraci√≥n lenta (p. ej., 4-7-8) pueden reducir la activaci√≥n antes de dormir?",
        ans: true,
        exp: "S√≠. Activan el sistema parasimp√°tico, reducen frecuencia cardiaca y facilitan el inicio del sue√±o."
      },
      {
        q: "¬øAcostarse solo cuando aparece somnolencia real es una pauta v√°lida de higiene del sue√±o?",
        ans: true,
        exp: "Correcto. Evita ir a la cama por horario si no hay somnolencia; as√≠ previenes asociaci√≥n cama-vigilia."
      }
    ];

    // ===== Mensajes psicoeducativos (uno por casilla; 50) =====
    const eduNotes = Array.from({length: N_STEPS}, (_, i) => {
      const base = i+1;
      const blocks = [
        "Constancia circadiana: intenta acostarte y levantarte a horarios similares diariamente. Tu reloj biol√≥gico se estabiliza y mejora la latencia.",
        "Ancla matutina: sal a la luz natural durante 10‚Äì30 minutos por la ma√±ana. La luz es un sincronizador potente del ritmo sue√±o-vigilia.",
        "Corte a pantallas: reduce exposici√≥n a luz azul 1‚Äì2 h antes de dormir o usa filtros nocturnos; protege la secreci√≥n de melatonina.",
        "Ambiente: prioriza una habitaci√≥n fresca (18‚Äì20¬∞C), oscura y silenciosa. Considera cortinas blackout, tapones o ruido blanco si es necesario.",
        "Rutina pre-sue√±o: crea un ritual relajante (lectura ligera, estiramientos suaves, respiraci√≥n lenta). Se√±aliza al cuerpo que es hora de bajar.",
        "Cafe√≠na: evita caf√©s, t√©s estimulantes y bebidas energ√©ticas desde media tarde. Recuerda la vida media de la cafe√≠na (3‚Äì7 h).",
        "Alcohol: no es un inductor de sue√±o saludable. Ev√≠talo cerca de la hora de acostarte para no fragmentar el sue√±o.",
        "Siesta: si necesitas, que sea breve (10‚Äì20 min) y temprana. Evita siestas largas que reduzcan la presi√≥n de sue√±o nocturna.",
        "Ejercicio: moverse a diario mejora la profundidad del sue√±o; solo evita la alta intensidad 2‚Äì3 h antes de dormir.",
        "Cama = dormir: usa la cama solo para dormir e intimidad. Si no concilias en ~20‚Äì30 min, lev√°ntate y vuelve con somnolencia.",
      ];
      // distribuye c√≠clicamente bloques y a√±ade detalle incremental
      const text = blocks[i % blocks.length] +
        " " +
        "Si tienes insomnio persistente, considera intervenci√≥n cognitivo-conductual (CBT-I), la terapia de primera l√≠nea seg√∫n gu√≠as cl√≠nicas.";
      return `Casilla ${base}: ${text}`;
    });

    // ===== Inicializaci√≥n del tablero =====
    function initBoard(){
      pathLen = track.getTotalLength();
      points = [];
      milestonesG.innerHTML = "";
      const stepLen = pathLen / (N_STEPS-1);
      for(let i=0;i<N_STEPS;i++){
        const p = track.getPointAtLength(i*stepLen);
        points.push({x:p.x, y:p.y});
        // dibuja hitos cada 5 para no saturar (y el primero/√∫ltimo)
        if(i===0 || i===N_STEPS-1 || i%5===0){
          const g = document.createElementNS("http://www.w3.org/2000/svg","g");
          const c = document.createElementNS("http://www.w3.org/2000/svg","circle");
          c.setAttribute("cx", p.x);
          c.setAttribute("cy", p.y);
          c.setAttribute("r", 10);
          c.setAttribute("class","milestone");
          const t = document.createElementNS("http://www.w3.org/2000/svg","text");
          t.setAttribute("x", p.x);
          t.setAttribute("y", p.y - 16);
          t.setAttribute("text-anchor","middle");
          t.textContent = i+1;
          g.appendChild(c); g.appendChild(t);
          milestonesG.appendChild(g);
        }
      }
      placePlayer(0);
      updateProgress();
      messageEl.textContent = "Lanza el dado para comenzar. Si respondes bien, avanzas; si fallas, retrocedes.";
      diceFace.textContent = "‚Äî";
      rollBtn.disabled = false;
      rollingLocked = false;
    }

    function placePlayer(idx){
      const p = points[idx];
      playerEmojiEl.setAttribute("x", p.x);
      playerEmojiEl.setAttribute("y", p.y - 16);
    }

    function animateTo(targetIdx, cb){
      // animaci√≥n simple paso a paso
      const dir = targetIdx > currentIdx ? 1 : -1;
      const total = Math.abs(targetIdx - currentIdx);
      let done = 0;
      function step(){
        if(done>=total){ cb && cb(); return; }
        currentIdx += dir;
        placePlayer(currentIdx);
        done++;
        requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    }

    function updateProgress(){
      progressEl.textContent = `Paso ${currentIdx+1} de ${N_STEPS}`;
    }

    // ===== L√≥gica principal =====
    function openQuestion(){
      const q = questions[Math.floor(Math.random()*questions.length)];
      qModal.classList.add('open');
      qModal.dataset.correct = q.ans ? "yes" : "no";
      qText.innerHTML = `<strong>${q.q}</strong>`;
      qFeedback.textContent = "";
      return q.exp;
    }

    function closeQuestion(){
      qModal.classList.remove('open');
    }

    function openEduNote(text){
      eduText.innerHTML = `<p>${text}</p><p style="margin-top:8px;color:#555;">${eduNotes[currentIdx]}</p>`;
      eduModal.classList.add('open');
    }

    function closeEduNote(){
      eduModal.classList.remove('open');
    }

    function handleAnswer(isYes){
      if(rollingLocked) return;
      const expected = qModal.dataset.correct === "yes";
      const correct = (isYes === expected);
      const exp = questions.find(q => q.q === qText.textContent)?.exp || "";
      qFeedback.innerHTML = (correct
        ? `<span class="badge">¬°Correcto!</span> ${exp}`
        : `<span class="badge">Respuesta incorrecta</span> ${exp}`);
      // calcula destino seg√∫n acierto
      const move = lastRoll;
      let target = currentIdx + (correct ? move : -move);
      if(target < 0) target = 0;
      if(target > N_STEPS-1) target = N_STEPS-1;

      rollingLocked = true;
      // Cerramos pregunta tras 1.2s para que lean la explicaci√≥n y luego movemos
      setTimeout(()=>{
        closeQuestion();
        animateTo(target, ()=>{
          updateProgress();
          // Al llegar, mostramos nota psicoeducativa larga (permanece hasta "Continuar")
          openEduNote(correct
            ? "Avanzas seg√∫n el dado. Integra esta pauta en tu pr√≥xima semana."
            : "Retrocedes seg√∫n el dado. Observa esta pauta y prueba un cambio concreto hoy.");
          // Si lleg√≥ al final, deshabilita
          if(currentIdx === N_STEPS-1){
            eduText.innerHTML = `<p><strong>¬°Meta alcanzada!</strong> Has completado el Camino al Buen Descanso.</p>
              <p>Te recomendamos consolidar 2‚Äì3 h√°bitos por semana. La consistencia gana al perfeccionismo.</p>
              <p style="margin-top:8px;color:#555;">${eduNotes[currentIdx]}</p>`;
            rollBtn.disabled = true;
          }
        });
      }, 4000);
    }

    // ===== Eventos =====
    rollBtn.addEventListener('click', ()=>{
      if(rollingLocked) return;
      lastRoll = Math.floor(Math.random()*6)+1;
      diceFace.textContent = lastRoll;
      const exp = openQuestion();
      messageEl.textContent = "Responde la pregunta. Si aciertas, avanzas; si fallas, retrocedes.";
    });

    btnYes.addEventListener('click', ()=>handleAnswer(true));
    btnNo.addEventListener('click', ()=>handleAnswer(false));

    btnContinue.addEventListener('click', ()=>{
      closeEduNote();
      rollingLocked = false;
      if(currentIdx === N_STEPS-1){
        messageEl.textContent = "Juego completado. ¬°Excelente trabajo!";
      }else{
        messageEl.textContent = "Lanza el dado para continuar tu camino.";
      }
    });

    resetBtn.addEventListener('click', ()=>{
      currentIdx = 0; lastRoll = 0; rollingLocked = false;
      initBoard();
    });

    avatarSel.addEventListener('change', (e)=>{
      playerEmojiEl.textContent = e.target.value;
    });

    // Cerrar modales al click fuera (opcional)
    [qModal, eduModal].forEach(modal=>{
      modal.addEventListener('click', (e)=>{
        if(e.target === modal){
          // Solo permitimos cerrar manualmente el modal educativo
          if(modal === eduModal){
            closeEduNote(); rollingLocked = false;
          }
        }
      });
    });

    // Init
    window.addEventListener('load', initBoard);
    window.addEventListener('resize', ()=>placePlayer(currentIdx));

    // ==== Chatbot ====
const faq = {
  "me cuesta dormir": "Es com√∫n en el insomnio inicial. Intenta una rutina relajante, evita pantallas 1-2h antes y usa t√©cnicas de respiraci√≥n lenta.",
  "no": "De acuerdo, espero que todo mejore".,
  "xd": "jajaja me gusta tu sentido del humo :p".,
  "XD": "jajaj xd".,
  "no tengo sue√±o": "Comprendo por lo que pasas, quieres que te cuente qu√© es la TCC-I (Terapia Cognitivo‚ÄìConductual para el Insomnio)?",
  "me despierto en la noche": "Eso es insomnio de mantenimiento. Lev√°ntate si est√°s despierto >20 min, haz algo tranquilo y regresa cuando sientas sue√±o. ¬øQuieres que te cuente qu√© es la TCC-I (Terapia Cognitivo‚ÄìConductual para el Insomnio)?",
  "me despierto muy temprano": "Eso se llama insomnio terminal. Puede mejorar con exposici√≥n a luz natural en la ma√±ana y evitando alcohol por la noche.",
  "debo tomar pastillas para dormir": "Los hipn√≥ticos solo se recomiendan en casos espec√≠ficos y a corto plazo. La terapia cognitivo-conductual para el insomnio (CBT-I) es la primera l√≠nea de tratamiento.",
  "las siestas son buenas": "Siestas cortas (10‚Äì20 min) y tempranas pueden ser beneficiosas, pero si son largas o tard√≠as, dificultan el sue√±o nocturno.",
  "el alcohol ayuda a dormir": "El alcohol facilita dormir al inicio, pero fragmenta el sue√±o y reduce el REM. No es recomendable.",
  "la cafeina afecta el sue√±o": "S√≠. La cafe√≠na tiene vida media de 3‚Äì7 horas. Ev√≠tala desde media tarde.",
  "la nicotina afecta el sue√±o": "S√≠. Es un estimulante que aumenta la latencia y fragmenta el sue√±o.",
  "guia autoinstructiva": "muy bien, veo que quieres empezar, para que iniciemos este viaje on√≠rico escribe: adelante",
  "mirar la hora ayuda": "No. Mirar el reloj aumenta la ansiedad y dificulta el sue√±o.",
  "que temperatura es mejor": "Lo ideal es mantener la habitacion fresca (18‚Äì20¬∞C), porque favorece la regulacion natural del sueno.",
  "debo dormir con luz": "Se recomienda dormir en oscuridad total o usar antifaz. La luz inhibe la melatonina y afecta la calidad del descanso.",
  "usar celular antes de dormir": "La luz azul de pantallas reduce la melatonina. Lo mejor es evitar pantallas al menos 1 hora antes de dormir.",
  "es bueno tomar cafe en la tarde": "La cafeina puede afectar el sueno incluso 6‚Äì8 horas despues de consumirla. Evita cafe en la tarde o noche.",
  "cuantas horas debo dormir": "La mayoria de adultos necesitan entre 7 y 9 horas de sueno reparador cada noche.",
  "que hacer si no me duermo rapido": "Si pasan mas de 20 minutos sin conciliar el sueno, lev√°ntate, haz una actividad relajante y vuelve a intentarlo.",
  "leer antes de dormir ayuda": "La lectura tranquila con luz tenue puede ayudar a relajarse. Evita lecturas estresantes o dispositivos con luz azul.",
  "hacer ejercicio de noche es malo": "El ejercicio intenso cerca de la hora de dormir puede activar demasiado el cuerpo. Mejor hacer actividad fisica por la manana o tarde.",
  "ense√±ame como aplicar tcc-i": "De acuerdo, para comenzar escribe: adelante",
  "tomar alcohol ayuda a dormir": "Aunque el alcohol puede inducir sueno, interrumpe las fases profundas y reduce la calidad del descanso.",
  "cual es la mejor posicion para dormir": "Dormir de lado, especialmente sobre el lado izquierdo, suele mejorar la respiracion y la digestion. Evita dormir boca abajo.",
  "es malo dormir con television": "Dormir con la TV encendida expone a luz y sonido que fragmentan el sueno. Mejor apagarla antes.",
  "usar melatonina es seguro": "La melatonina puede ser util en ciertos casos, pero debe usarse bajo indicacion medica.",
  "que hacer si me despierto en la madrugada": "No te quedes mucho tiempo en la cama despierto. Haz una actividad tranquila y vuelve cuando sientas sueno.",
  "como relajarme antes de dormir": "Practica respiracion profunda, meditacion, estiramientos suaves o escucha musica relajante.",
  "el ruido afecta el sueno": "Los ruidos interrumpen el sueno profundo. Usa tapones o ruido blanco si es necesario.",
  "cual es la mejor rutina nocturna": "Seguir una rutina consistente (cena ligera, higiene, lectura tranquila, apagar pantallas) prepara al cuerpo para dormir.",
  "dormir mucho es malo": "Dormir en exceso de forma cronica puede estar asociado con problemas de salud. El rango ideal es 7‚Äì9 horas.",
  "despertar varias veces es normal": "Despertares breves son normales, pero si son frecuentes y afectan tu descanso, conviene evaluarlo.",
  "puedo tomar te antes de dormir": "Infusiones sin cafeina como manzanilla o tilo pueden ayudar a relajarse. Evita te negro o verde en la noche.",
  "dormir con mascotas es malo": "Las mascotas pueden interrumpir el sueno con movimientos o ruidos. Considera tener su espacio separado.",
  "cambiar colch√≥n ayuda": "Un colchon adecuado a tu postura y sin hundimientos mejora el descanso y previene dolores.",
  "que comer antes de dormir": "Opta por una cena ligera, evitando comidas grasosas o muy picantes. Incluye alimentos ricos en triptofano como leche o banano.",
  "cenar tarde afecta": "Comer muy tarde o pesado retrasa la digestion y empeora el sueno. Lo ideal es cenar 2‚Äì3 horas antes de dormir.",
  "es bueno escuchar musica": "La musica suave y lenta puede inducir relajacion y facilitar el sueno.",
  "sirve escribir antes de dormir": "Escribir preocupaciones o planificar el dia siguiente puede liberar la mente y favorecer el descanso.",
  "usar aroma ayuda": "Aromas como lavanda o manzanilla se asocian con mejor relajacion y calidad de sueno.",
  "ducharse antes de dormir": "Una ducha tibia ayuda a bajar la temperatura corporal y senalar al cuerpo que es hora de dormir.",
  "puedo trabajar en la cama": "Evita usar la cama para trabajar o estudiar. Asociala solo con dormir y descansar.",
  "no puedo dormir": "Entiendo, ¬øquieres que te cuente qu√© es la TCC-I (Terapia Cognitivo‚ÄìConductual para el Insomnio), que es el tratamiento m√°s recomendado?",
  "adelante": "‚ÄúPerfecto. Te guiar√© en 20 pasos pr√°cticos que puedes aplicar de forma autoinstuctiva la TCC-I. Solo tienes que escribir paso 1, paso 2‚Ä¶ hasta el paso 20. Empecemos cuando quieras ‚ú®.",
  "si": "La TCC-I es un conjunto de estrategias psicol√≥gicas basadas en evidencia cient√≠fica que ayudan a mejorar la calidad del sue√±o sin depender de pastillas. ¬øQuieres que te muestre una gu√≠a de 20 pasos pr√°cticos para aplicarla t√∫ mismo? Si es as√≠, escribe: adelante",
  "hace dias no duermo": "El insomnio recurrente merece atencion. Mantener horarios regulares y evitar cafeina puede ayudar, pero si persiste, consulta con un especialista.",
  "paso 1": "üìò Paso 1: Autoevaluaci√≥n inicial.\n\nDedica unos minutos a reflexionar y anotar c√≥mo son tus noches: ¬øcu√°nto tardas en dormirte? ¬øte despiertas a menudo? ¬øc√≥mo te sientes al d√≠a siguiente? Esto te dar√° una l√≠nea base para medir tus progresos.",
  "paso 2": "üìì Paso 2: Diario del sue√±o.\n\nDurante 7 d√≠as registra la hora a la que te acuestas, cu√°ndo te levantas, n√∫mero de despertares y calidad del descanso. Esto te ayudar√° a identificar patrones y factores que interfieren con tu sue√±o.",
  "paso 3": "üß† Paso 3: Aprende sobre el sue√±o.\n\nEl sue√±o tiene ciclos (NREM y REM). Lo normal es despertarse brevemente varias veces en la noche. Entender esto reduce la ansiedad de ‚Äòno dormir bien‚Äô.",
  "paso 4": "‚è∞ Paso 4: Horario regular.\n\nElige una hora fija para despertarte todos los d√≠as, incluso fines de semana. Esto entrena tu reloj biol√≥gico y mejora la calidad del sue√±o con el tiempo.",
  "paso 5": "üõè Paso 5: Control de est√≠mulos.\n\nLa cama solo debe usarse para dormir o intimidad. Evita leer, mirar el m√≥vil o trabajar en ella. As√≠ tu cerebro vuelve a asociarla solo con descanso.",
  "paso 6": "üö∂ Paso 6: Si no duermes, lev√°ntate.\n\nSi pasan m√°s de 20 minutos y no concilias el sue√±o, sal de la cama y haz algo relajante con poca luz. Vuelve solo cuando sientas somnolencia.",
  "paso 7": "üìâ Paso 7: Restricci√≥n del sue√±o.\n\nCalcula el promedio real de horas que duermes (ej. 5,5 h). Durante 1 semana, lim√≠tate a estar en cama ese tiempo exacto, no m√°s. Luego ampl√≠a poco a poco seg√∫n mejores.",
  "paso 8": "üò¥ Paso 8: Evita siestas largas.\n\nSi necesitas descansar, haz una siesta de m√°ximo 20‚Äì30 minutos y nunca despu√©s de las 3 pm. Esto mantiene tu ‚Äòpresi√≥n de sue√±o‚Äô para la noche.",
  "paso 9": "üè† Paso 9: Optimiza tu habitaci√≥n.\n\nProcura que est√© fresca (18‚Äì20¬∞C), oscura y silenciosa. Usa cortinas blackout, tapones de o√≠do o una m√°quina de ruido blanco si es necesario.",
  "paso 10": "üåô Paso 10: Crea un ritual pre-sue√±o.\n\nEstablece 20‚Äì30 minutos antes de dormir para actividades relajantes: leer un libro, escuchar m√∫sica tranquila o hacer respiraci√≥n profunda.",
  "paso 11": "‚òï Paso 11: Control de sustancias.\n\nReduce cafe√≠na, nicotina y alcohol. La cafe√≠na puede afectar tu sue√±o hasta 6‚Äì8 horas despu√©s de consumirla.",
  "paso 12": "üí≠ Paso 12: Reestructura tus pensamientos.\n\nSi piensas 'si no duermo me arruinar√© ma√±ana', c√°mbialo por: 'aunque duerma poco, podr√© funcionar; mi cuerpo sabe recuperarse'.",
  "paso 13": "üåÄ Paso 13: Acepta la incertidumbre.\n\nNo intentes forzar el sue√±o. En lugar de luchar, recu√©rdate: 'si no me duermo de inmediato, es normal, y mi cuerpo descansar√° cuando lo necesite'.",
  "paso 14": "üìã Paso 14: Tiempo para preocupaciones.\n\nDedica 15 minutos en la tarde a escribir pendientes y soluciones. As√≠ entrenas a tu mente a no resolver problemas en la cama.",
  "paso 15": "‚òÄÔ∏è Paso 15: Exposici√≥n a la luz natural.\n\nAl despertar, abre las cortinas o sal a caminar. La luz de la ma√±ana regula tu reloj interno y mejora el inicio del sue√±o nocturno.",
  "paso 16": "üèÉ Paso 16: Ejercicio f√≠sico.\n\nRealiza actividad moderada (caminar, bicicleta, yoga). Hazlo al menos 4‚Äì5 horas antes de dormir para que no interfiera con la conciliaci√≥n del sue√±o.",
  "paso 17": "üßò Paso 17: T√©cnicas de relajaci√≥n.\n\nPractica relajaci√≥n muscular progresiva o respiraci√≥n 4-7-8. Estas t√©cnicas reducen activaci√≥n fisiol√≥gica y ansiedad.",
  "paso 18": "‚è≥ Paso 18: Evita mirar el reloj.\n\nQuita el despertador de tu vista. Vigilar la hora aumenta la presi√≥n y el miedo a ‚Äòno dormir‚Äô.",
  "paso 19": "üìà Paso 19: Consolida avances.\n\nAplica estas estrategias al menos 4‚Äì6 semanas. La constancia es clave: tu cerebro necesita tiempo para reprogramar asociaciones con el sue√±o.",
  "paso 20": "üõ° Paso 20: Prevenci√≥n de reca√≠das.\n\nEn periodos de estr√©s o viajes, vuelve a aplicar control de est√≠mulos, rutina regular y t√©cnicas de relajaci√≥n. Recuerda: el insomnio puede mejorar y mantenerse estable con pr√°ctica.",
  "estoy despierto toda la madrugada": "Despertar en medio de la noche puede ser frustrante. Evita mirar el reloj, practica respiracion o meditacion para volver a dormir.",
  "me despierto a cada rato": "Los despertares frecuentes pueden estar relacionados con estres o habitos. Revisa tu rutina de sueno y tu consumo de cafeina o alcohol.¬øQuieres que te cuente qu√© es la TCC-I (Terapia Cognitivo‚ÄìConductual para el Insomnio)?",
  "duermo muy poco": "Dormir menos de 5 horas regularmente puede afectar la salud. Intenta mejorar tus rutinas y busca apoyo profesional si continua. ¬øQuieres que te cuente qu√© es la TCC-I (Terapia Cognitivo‚ÄìConductual para el Insomnio)?",
  "me acuesto y no me da sueno": "La mente activa retrasa el inicio del sueno. Establece una rutina de relajacion antes de acostarte.",
  "me levanto varias veces": "Es normal despertar brevemente, pero si ocurre seguido puede ser insomnio fragmentado. Cuidar el ambiente de descanso puede ayudar.",
  "me despierto muy temprano": "Despertar antes de lo planeado es una forma de insomnio. La exposicion a la luz natural por la manana puede ayudar a regularlo.",
  "tengo insomnio": "El insomnio es comun pero tratable. Identificar habitos que lo empeoran es un buen primer paso. ¬øQuieres que te cuente qu√© es la TCC-I (Terapia Cognitivo‚ÄìConductual para el Insomnio)?",
  "me cuesta conciliar el sueno": "La higiene del sueno incluye horarios regulares, ambiente oscuro y sin pantallas antes de dormir.",
  "me siento cansado aunque duerma": "Puede deberse a sueno poco reparador. Intenta evaluar la calidad, no solo la cantidad, de horas dormidas.",
  "mi cabeza no para de pensar": "Los pensamientos acelerados son una causa comun de insomnio. Tecnicas de mindfulness pueden ayudarte a calmar la mente.",
  "duermo tarde y me levanto temprano": "La deuda de sueno se acumula. Intenta adelantar progresivamente tu hora de dormir.",
  "me da ansiedad en la noche": "La ansiedad dificulta conciliar el sueno. Practicar respiracion lenta y rutinas calmantes puede reducirla.",
  "estoy agotado y no puedo dormir": "La fatiga sin descanso adecuado puede ser senal de insomnio cronico. Conviene buscar estrategias y apoyo clinico.",
  "mi sueno es muy ligero": "El sueno superficial no permite recuperacion completa. Evita ruido, luz y cafeina para mejorar la profundidad.",
  "duermo en ratos cortos": "El sueno fragmentado afecta la memoria y el estado de animo. Puede mejorar con rutinas consistentes.",
  "me desvelo siempre": "El habito de desvelarse desajusta el reloj biologico. Dormir y levantarse a la misma hora ayuda mucho. ¬øQuieres que te cuente qu√© es la TCC-I (Terapia Cognitivo‚ÄìConductual para el Insomnio)?",
  "doy vueltas en la cama": "Si llevas mas de 20 minutos sin dormir, es mejor levantarse y hacer algo tranquilo hasta que aparezca el sueno.",
  "ya no se que hacer para dormir": "Esa sensacion de desesperanza es comun. Recuerda que el insomnio tiene tratamiento y la psicoeducacion es un buen inicio. ¬øQuieres que te cuente qu√© es la TCC-I (Terapia Cognitivo‚ÄìConductual para el Insomnio)?",  
  "despertador afecta el sueno": "El sonido fuerte del despertador interrumpe bruscamente el sueno. Despertar con luz natural o alarmas suaves es mejor.",
  "como evitar pesadillas": "Reduce el estres, evita comidas pesadas y cafeina antes de dormir. Mantener un ambiente tranquilo ayuda.",
  "sirve meditar antes de dormir": "La meditacion reduce el estres y mejora la calidad del descanso en personas con insomnio.",
  "que hacer si me da hambre en la noche": "Elige un snack ligero como fruta o yogurt natural. Evita azucar y comidas pesadas.",
  "es bueno tomar leche": "La leche contiene triptofano, precursor de la melatonina, lo cual puede favorecer el sueno.",
  "dormir con frio es malo": "Un poco de frescura ayuda, pero si el ambiente es demasiado frio puede interrumpir el descanso.",
  "dormir con calor es malo": "El exceso de calor impide que el cuerpo baje su temperatura interna. Usa ropa ligera y ventilacion.",
  "usar apps de sueno ayuda": "Las apps pueden ser utiles para registrar habitos, pero no reemplazan una evaluacion clinica.",
  "sirve contar ovejas": "No es muy eficaz. Es mejor practicar tecnicas de respiracion o visualizacion relajante.",
  "cambiar horarios de sueno": "Dormir y despertar siempre a la misma hora regula el reloj biologico y mejora el descanso.",
  "hacer ejercicio de noche ayuda": "El ejercicio es positivo si es en el d√≠a. Evita intensidad alta 2‚Äì3h antes de dormir.",
  "la luz natural sirve": "S√≠. La exposici√≥n a luz natural por la ma√±ana ayuda a regular tu ritmo circadiano.",
  "debo usar la cama para leer o ver tv": "No. La cama debe asociarse solo con dormir o intimidad, as√≠ entrenas al cerebro a relajarse al acostarte.",
  "que hago si no puedo dormir": "Lev√°ntate tras 20‚Äì30 min, haz algo tranquilo con poca luz y regresa solo cuando tengas sue√±o. ¬øQuieres que te cuente qu√© es la TCC-I (Terapia Cognitivo‚ÄìConductual para el Insomnio)?",
  "tengo insomnio cronico": "Consulta a un profesional de salud. La CBT-I es el tratamiento recomendado con m√°s evidencia cient√≠fica. ¬øQuieres que te cuente qu√© es la TCC-I (Terapia Cognitivo‚ÄìConductual para el Insomnio)?"
};

function toggleChat(){
  const chat = document.getElementById("chatbot");
  chat.style.display = chat.style.display === "flex" ? "none" : "flex";
}

function sendMessage(){
  const input = document.getElementById("chatInput");
  const msg = input.value.trim();
  if(!msg) return;
  addMessage("T√∫", msg);

  const norm = msg.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
  let found = null;
  for(const key in faq){
    if(norm.includes(key)) { found = faq[key]; break; }
  }
  addMessage("üò¥", found || "No tengo una respuesta exacta, pero recuerda: mantener horarios constantes, ambiente adecuado y evitar pantallas ayuda mucho al descanso. ¬øDeseas que te ense√±e c√≥mo aplica las TCC-I?");
  input.value = "";
}

function addMessage(sender, text){
  const box = document.getElementById("chatMessages");
  const p = document.createElement("p");
  p.innerHTML = `<strong>${sender}:</strong> ${text}`;
  box.appendChild(p);
  box.scrollTop = box.scrollHeight;
}

  </script>
</body>
</html>
